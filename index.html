<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DEMOFM | MATRIX/BAUHAUS</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- PWA MANIFEST (Base64 Encoded JSON for single-file operation) -->
    <!-- Content: name=DEMOFM - MATRIX, display=standalone, icons point to placeholders -->
    <link rel="manifest" href="data:application/json;base64,eyJkZXNjcmlwdGlvbiI6ICJNYXRyaXgvQmF1aGF1cyBBdWRpbyBUZXJtaW5hbC4iLCAiaWNvbnMiOiBbeyJzaXplcyI6ICIxOTJ4MTkyIiwgInNyYyI6ICJodHRwczovL3BsYWNlaG9sZC5jby8xOTJ4MTkyLzAwMDAwMC8wMGZmMDA/dGV4dD1EIEYiLCAidHlwZSI6ICJpbWFnZS9wbmciIH0sIHsic2l6ZXMiOiAiNTEyeDUxMiIsICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvb mote C/NTEyeDUxMi8wMDAwMDAvMDBmZjAwP3RleHQ9RCBGIE0iLCAidHlwZSI6ICJpbWFnZS9wbmciIH1dLCAibmFtZSI6ICJERU1PRk0gLSBNQVRSSVgiLCAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwgInN0YXJ0X3VybCI6ICIuLyIsICJzaG9ydF9uYW1lIjogIkRFTU9GTSIsICJ0aGVtZV9jb2xvciI6ICIjMDAwMDAwIiwgImJhY2tncm91bmRfY29sb3IiOiAiIzAwMDAwMCJ9">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/000000/00ff00?text=D+F">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://w.soundcloud.com/player/api.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- BAUHAUS/MATRIX STYLES --- */
        :root {
            --bg: #000000;
            --fg: #00ff00; /* Matrix Green */
            --border: 1px solid var(--fg);
            --font-main: 'Courier Prime', 'Courier New', monospace;
        }

        body {
            background-color: var(--bg);
            color: var(--fg);
            font-family: var(--font-main);
            min-height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.5rem;
            box-sizing: border-box;
        }
        
        /* Main Application Frame (Maximized, no fluff) */
        .app-frame {
            background-color: var(--bg);
            width: 100%;
            max-width: 1400px;
            height: 98vh;
            max-height: 900px;
            border: var(--border);
            overflow: hidden;
        }

        /* --- UI Components --- */
        .module-box {
            border: var(--border);
            padding: 0.75rem;
            background-color: var(--bg);
        }
        
        .btn-matrix {
            background: var(--bg);
            color: var(--fg);
            padding: 8px 12px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            border: var(--border);
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1; /* Crisp text */
        }

        /* Inverted colors on hover/active for functional feedback */
        .btn-matrix:hover, .btn-matrix.active {
            background: var(--fg);
            color: var(--bg);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border: 1px solid var(--fg);
            background-color: transparent;
            margin-right: 6px;
            transition: background-color 0.2s;
        }

        .btn-matrix.active .status-dot {
            background: var(--bg); /* Inverted color */
        }

        .pulsate { animation: pulsate-anim 1s linear infinite; }
        @keyframes pulsate-anim { 50% { opacity: 0.5; } }

        /* Track/Info Display - Single line, minimal noise */
        .info-display {
            background: var(--bg);
            border: var(--border);
            color: var(--fg);
            padding: 0.5rem;
            font-size: 1.1rem;
            overflow: hidden;
            white-space: nowrap;
        }

        /* Volume Slider - Clean, functional styling */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            height: 2px;
            background: var(--fg);
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 10px;
            height: 10px;
            background: var(--fg);
            border: 1px solid var(--bg);
        }

        /* --- Layout --- */
        .layout-grid {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        @media (min-width: 768px) {
            .layout-grid {
                flex-direction: row;
            }
            .sidebar {
                width: 300px;
                flex-shrink: 0;
                border-right: var(--border);
            }
        }
        .content-area {
            border-top: var(--border);
            padding: 0.75rem;
        }

        .scroll-hide::-webkit-scrollbar { display: none; }
        .scroll-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <!-- MAIN APP FRAME -->
    <div class="app-frame layout-grid">

        <!-- LEFT COLUMN: CONTROLS & NAV -->
        <aside class="sidebar flex flex-col h-auto md:h-full p-2 gap-3">
            
            <!-- 1. HEADER LOGO -->
            <div class="module-box p-3 border-none flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-black tracking-tighter leading-none text-red-500">
                        <span style="color: var(--fg);">DEMO</span>FM
                    </h1>
                    <p class="text-xs mt-1">V6.2 // ONLINE</p>
                </div>
                <!-- Status indicator -->
                <div id="connection-dot" class="status-dot"></div>
            </div>

            <!-- 2. PLAYER MODULE -->
            <div class="module-box flex flex-col gap-3">
                <div class="flex justify-between items-center text-xs pb-2 border-b border-dashed border-current">
                    <span>AUDIO_MATRIX</span>
                    <span id="player-status" class="text-xs">IDLE</span>
                </div>
                
                <!-- Track Display -->
                <div class="info-display">
                    <span id="track-name" class="block whitespace-nowrap overflow-hidden text-ellipsis">COMMENCING BROADCAST...</span>
                </div>

                <!-- Controls -->
                <div class="grid grid-cols-3 gap-2 mt-1">
                    <button onclick="toggleAudio()" class="btn-matrix">
                        ⏯
                    </button>
                    <button onclick="skipTrack()" class="btn-matrix">
                        ⏭
                    </button>
                    <button onclick="randomSkip()" class="btn-matrix">
                        RND
                    </button>
                </div>

                <!-- Volume -->
                <div class="flex items-center gap-3 mt-2">
                    <!-- ADDED UI FEEDBACK SPAN FOR VOLUME PERCENTAGE -->
                    <span class="text-xs w-1/5">VOLUME [<span id="vol-percent">70</span>%]</span>
                    <input type="range" min="0" max="100" value="70" id="volume-slider" class="flex-1" oninput="setVolume(this.value)">
                </div>
            </div>

            <!-- 3. NAVIGATION -->
            <nav class="module-box flex flex-col gap-2 flex-grow">
                <button onclick="navigate('live')" id="btn-live" class="btn-matrix active">
                    <span class="status-dot"></span> <span>LIVE FEED</span>
                </button>
                <button onclick="navigate('video')" id="btn-video" class="btn-matrix">
                    <span class="status-dot"></span> <span>VIDEO FEED</span>
                </button>
                <button onclick="navigate('news')" id="btn-news" class="btn-matrix">
                    <span class="status-dot"></span> <span>DATA STREAM</span>
                </button>
                <button onclick="navigate('about')" id="btn-about" class="btn-matrix">
                    <span class="status-dot"></span> <span>PROTOCOL</span>
                </button>
            </nav>
            
             <!-- Listener Count (Functional Component) -->
            <div class="module-box text-center">
                <div id="listener-count" class="text-2xl font-bold">--</div>
                <div class="text-xs mt-1">LISTENERS CONNECTED</div>
            </div>

        </aside>

        <!-- RIGHT COLUMN: CONTENT SCREEN -->
        <main class="flex-1 relative overflow-hidden flex flex-col">
            
            <!-- Window Header -->
            <div class="bg-black text-white p-2 flex justify-between items-center text-sm font-bold border-b border-current" style="color: var(--fg);">
                <span id="screen-title">LIVE FREQUENCY</span>
                <!-- Time Display -->
                <span class="text-xs border border-current px-1" id="clock">00:00:00</span>
            </div>

            <!-- Scrollable Content Area -->
            <div class="overflow-y-auto h-full scroll-hide relative content-area" id="content-area">
                
                <!-- TAB: LIVE -->
                <div id="view-live" class="view-section">
                    <div class="module-box p-4 mb-4 border-dashed">
                        <h2 class="text-xl font-bold mb-2 uppercase">CURRENT BROADCAST</h2>
                        <p class="text-sm border-t border-dashed border-current pt-2">
                            STATUS: <span class="text-red-500">STREAMING @ 320 KBPS</span><br>
                            SOURCE: Fusion Festival 2019 Set Archive
                        </p>
                    </div>
                    
                    <h3 class="text-lg font-bold uppercase mt-6 mb-2">NETWORK LOG</h3>
                    <div class="module-box p-4 h-48 overflow-y-auto text-sm">
                        <ul id="network-log" class="space-y-1">
                            <!-- JS Log will go here -->
                        </ul>
                    </div>
                </div>

                <!-- TAB: VIDEO (NEW) -->
                <div id="view-video" class="view-section hidden">
                    <h2 class="text-xl font-bold uppercase mb-4 border-b border-current pb-1">LIVE VIDEO SIGNAL</h2>
                    
                    <!-- Responsive 16:9 Aspect Ratio Video Container -->
                    <div class="module-box p-1" style="height: 0; padding-bottom: 56.25%; position: relative;">
                        <iframe 
                            width="100%" 
                            height="100%" 
                            src="https://www.youtube.com/embed/OatUMBSDQyo?autoplay=1&mute=1&controls=0&showinfo=0&rel=0" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                            allowfullscreen 
                            style="position: absolute; top: 0; left: 0;"
                            title="Live Video Feed">
                        </iframe>
                    </div>
                    <p class="mt-4 text-sm">SIGNAL SOURCE: YOUTUBE. AUTOPLAY MUTED DUE TO STREAM CONFLICT. CONTROLS HIDDEN.</p>
                </div>

                <!-- TAB: NEWS (DATA STREAM) -->
                <div id="view-news" class="view-section hidden">
                    <h2 class="text-xl font-bold uppercase mb-4 border-b border-current pb-1">DATA STREAM (ANNOUNCEMENTS)</h2>
                    <div id="news-feed" class="flex flex-col gap-2">
                        <!-- Dynamic Grounded News will be injected here -->
                    </div>
                </div>

                <!-- TAB: ABOUT (PROTOCOL) -->
                <div id="view-about" class="view-section hidden">
                    <h2 class="text-xl font-bold uppercase mb-4 border-b border-current pb-1">SYS.PROTOCOL V6.2</h2>
                    <p class="mb-4 text-sm leading-relaxed">
                        DEMOFM is a non-profit, non-commercial broadcast initiative. The interface is designed for maximum function and minimal aesthetic distraction. This system operates on a stripped-down Matrix/Bauhaus framework. The DATA STREAM now integrates real-time, grounded summaries from external nodes.
                    </p>
                    <div class="module-box p-3 text-sm">
                        <p><strong>OPERATOR:</strong> MG</p>
                        <p><strong>FRAMEWORK:</strong> HTML5/Tailwind-V6</p>
                        <p><strong>FONT:</strong> Courier Prime</p>
                    </div>
                </div>

            </div>

            <!-- Global Status Log Footer -->
            <div class="bg-black text-xs font-bold p-1 border-t border-current sticky bottom-0 flex-shrink-0">
                <span class="text-red-500 font-bold px-1">LOG:</span>
                <span id="sys-log">System Initializing...</span>
            </div>

        </main>
    </div>

    <!-- SOUNDCLOUD WIDGET (Hidden) -->
    <iframe id="sc-widget" 
            src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/ticket-countdown/sets/fusion-festival-2019-sets&color=%2300ff00&auto_play=false&hide_related=false&show_comments=false&show_user=true&show_reposts=false&show_teaser=true&visual=true" 
            width="100%" 
            height="166" 
            scrolling="no" 
            frameborder="no" 
            allow="autoplay" 
            style="display: none;">
    </iframe>

    <script>
        // --- API CONFIG ---
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- UTILITIES ---
        const networkLog = document.getElementById('network-log');
        const feedContainer = document.getElementById('news-feed');
        let currentListeners = 1; 
        let newsData = null; // Cache for the generated news
        let isGenerating = false;

        function log(msg) {
            const sysLogEl = document.getElementById('sys-log');
            sysLogEl.innerText = `> ${msg}`;
            
            const li = document.createElement('li');
            const timestamp = new Date().toTimeString().split(' ')[0];
            li.innerHTML = `[${timestamp}] ${msg}`;
            networkLog.prepend(li); 
            
            while (networkLog.children.length > 10) {
                networkLog.removeChild(networkLog.lastChild);
            }
        }
        
        // --- NAVIGATION ---
        function navigate(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.btn-matrix').forEach(el => el.classList.remove('active'));

            document.getElementById('view-' + viewId).classList.remove('hidden');
            document.getElementById('btn-' + viewId).classList.add('active');

            const titleMap = {
                live: 'LIVE FREQUENCY',
                video: 'VIDEO SIGNAL', // Added video
                news: 'DATA STREAM',
                about: 'SYS.PROTOCOL'
            };
            document.getElementById('screen-title').innerText = titleMap[viewId];
            log(`Navigation: Viewpoint set to ${viewId.toUpperCase()}`); 
            
            if (viewId === 'news') {
                displayNewsFeed();
            }
            // Mute SoundCloud player if navigating to video tab
            if (viewId === 'video' && isPlaying) {
                 widget.setVolume(0);
                 log("AUDIO MATRIX: Muted for video signal.");
            } else if (viewId !== 'video') {
                 // Restore volume if not on video tab and player is active/ready
                 const volumeValue = document.getElementById('volume-slider').value;
                 setVolume(volumeValue);
            }
        }

        // --- NEWS FEED GENERATOR (DYNAMIC) ---
        async function generateNewsFeed() {
            if (isGenerating) return;

            isGenerating = true;
            log("DATA STREAM: Requesting grounded feed from AI core...");
            feedContainer.innerHTML = '<div class="module-box p-4 text-center pulsate">ACCESSING GROUNDED DATA STREAM... PLEASE WAIT.</div>';

            // Prompt requests real-world, grounded news summaries from specific sources with links
            const userQuery = "Generate 5 short, concise, and hyper-functional news items or status reports by summarizing the latest headlines and articles from 'newmodels.io' and 'Drudge Report'. The output must be mixed between the two sources. The tone must be strictly technical and minimal, following the principles of 'form follows function'. Please attribute the 'src' field to either 'NEWMODELS' or 'DRUDGE'.";
            
            const systemPrompt = "You are a stark, minimal system reporter. Provide only factual, functional updates formatted as requested JSON, ensuring each item is grounded in a current source and includes the source URL.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                // Use Google Search for grounding (real news)
                tools: [{ "google_search": {} }], 
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "title": { "type": "STRING", "description": "The concise news headline or status report based on the source." },
                                "src": { "type": "STRING", "description": "The attributed source: 'NEWMODELS' or 'DRUDGE'." },
                                "date": { "type": "STRING", "description": "Relative date/time, e.g., 'TODAY 11:45', 'T-2HRS'." },
                                "url": { "type": "STRING", "description": "The link to the article from the source." }
                            },
                            required: ["title", "src", "date", "url"],
                            propertyOrdering: ["title", "src", "date", "url"]
                        }
                    }
                }
            };
            
            const maxRetries = 5;
            let delay = 1000;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const result = await response.json();
                    
                    // Extract and parse JSON text
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!jsonText) throw new Error("API response missing content.");
                    
                    newsData = JSON.parse(jsonText);
                    log("DATA STREAM: Grounded feed successfully generated and cached.");
                    renderNewsFeed(newsData);
                    isGenerating = false;
                    return;

                } catch (error) {
                    console.error("AI Core Error:", error);
                    if (attempt === maxRetries - 1) {
                        log(`ERROR: Failed to generate data stream after ${maxRetries} attempts.`);
                        renderNewsFeed(null, 'ERROR: NETWORK FAILED. RETRY LATER.');
                        isGenerating = false;
                        return;
                    }
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
            }
        }

        function renderNewsFeed(items, errorMessage = null) {
            feedContainer.innerHTML = ''; 

            if (errorMessage) {
                feedContainer.innerHTML = `<div class="module-box p-4 text-center text-red-500 font-bold">${errorMessage}</div>`;
                return;
            }

            if (!items || items.length === 0) {
                feedContainer.innerHTML = `<div class="module-box p-4 text-center">DATA STREAM EMPTY. PRESS REFRESH.</div>`;
                return;
            }
            
            items.forEach(item => {
                const a = document.createElement('a'); // Use <a> tag for clickable link
                a.href = item.url || '#'; 
                a.target = '_blank'; // Open in new tab
                
                a.className = 'module-box p-3 cursor-pointer hover:bg-green-900 transition text-sm block'; // Added 'block' for full link area
                a.innerHTML = `
                    <div class="flex justify-between border-b border-dashed border-current pb-1 mb-1">
                        <span class="text-red-500">${item.src || 'UNKNOWN_SRC'}</span>
                        <span>${item.date || 'DATETIME_ERR'}</span>
                    </div>
                    <h3 class="font-bold leading-tight">${item.title || 'CONTENT_ERROR'}</h3>
                `;
                feedContainer.appendChild(a);
            });
        }

        function displayNewsFeed() {
            if (newsData && !isGenerating) {
                // If cached, display instantly
                renderNewsFeed(newsData);
            } else if (!isGenerating) {
                // If not cached, fetch new data
                generateNewsFeed();
            }
            // If isGenerating is true, do nothing, the loading indicator is already shown.
        }

        // --- LISTENER COUNT SIMULATION ---
        function updateListeners() {
            document.getElementById('listener-count').innerText = currentListeners.toString().padStart(2, '0');
        }
        
        // --- AUDIO ENGINE ---
        var widgetIframe = document.getElementById('sc-widget');
        var widget = SC.Widget(widgetIframe);
        var isPlaying = false;
        const statusDot = document.getElementById('connection-dot');

        log("Initializing Audio Matrix...");
        updateListeners(); // Set initial count

        // Removed widget.setVolume(0.7) from here, now set in init section below

        widget.bind(SC.Widget.Events.READY, function() {
            log("Audio Matrix Online. Awaiting command.");
            document.getElementById('track-name').innerText = "READY // ACTIVATE STREAM";
            document.getElementById('player-status').innerText = "IDLE";
            statusDot.classList.remove('pulsate');
            
            // Set initial volume after widget is ready, using the slider's default value
            const initialVolume = document.getElementById('volume-slider').value;
            setVolume(initialVolume);
        });

        widget.bind(SC.Widget.Events.PLAY, function() {
            isPlaying = true;
            document.getElementById('player-status').innerText = "STREAMING";
            statusDot.classList.add('pulsate');
            statusDot.style.backgroundColor = 'var(--fg)';
            
            widget.getCurrentSound(function(sound) {
                if(sound) {
                    let title = sound.title;
                    if(title.length > 30) title = title.substring(0, 30) + "...";
                    document.getElementById('track-name').innerText = title.toUpperCase();
                    log(`Now Playing: ${title}`);
                } else {
                    document.getElementById('track-name').innerText = "ERROR // TRACK INFO UNAVAILABLE";
                    log("WARNING: Track metadata unavailable.");
                }
            });
        });

        widget.bind(SC.Widget.Events.PAUSE, function() {
            isPlaying = false;
            document.getElementById('player-status').innerText = "PAUSED";
            statusDot.classList.remove('pulsate');
            statusDot.style.backgroundColor = 'transparent';
        });

        function toggleAudio() {
            if(!widget) return;
            widget.toggle();
        }

        function skipTrack() {
            if(!widget) return;
            log("Jumping to NEXT track.");
            widget.next();
        }
        
        function randomSkip() {
            if (!widget) return;
            // Skip 1 to 4 tracks forward
            const skipCount = Math.floor(Math.random() * 4) + 1; 
            log(`RANDOM SKIP: ${skipCount} tracks forward.`);
            
            let i = 0;
            // Sequential next() calls to simulate a random jump
            const interval = setInterval(() => {
                if (i < skipCount) {
                    widget.next();
                    i++;
                } else {
                    clearInterval(interval);
                    // Wait for the final track to load before logging
                    setTimeout(() => {
                        widget.getCurrentSound(function(sound) {
                            if (sound) {
                                log(`Randomized to: ${sound.title}`);
                            }
                        });
                    }, 500);
                }
            }, 100); 
        }

        function setVolume(val) {
            if(!widget) return;
            const volumeValue = parseInt(val, 10);
            
            // 1. Update SoundCloud widget
            widget.setVolume(volumeValue / 100); 
            
            // 2. Update UI for immediate feedback
            const volPercentEl = document.getElementById('vol-percent');
            if (volPercentEl) {
                volPercentEl.innerText = volumeValue;
            }
            
            log(`Volume: ${volumeValue}%`);
        }
        
        // --- CLOCK (Including seconds for more technical look) ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = 
                now.getHours().toString().padStart(2,'0') + ':' + 
                now.getMinutes().toString().padStart(2,'0') + ':' +
                now.getSeconds().toString().padStart(2,'0');
        }

        setInterval(updateClock, 1000);

        // Initialize on Live view
        navigate('live');
        updateClock();


        // --- PWA SERVICE WORKER REGISTRATION (Embedded) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Service Worker content as a Blob URL
                const swContent = `
                    const CACHE_NAME = 'demofm-matrix-v6-2'; // Updated cache name
                    const urlsToCache = [
                      './', 
                      'https://cdn.tailwindcss.com',
                      'https://w.soundcloud.com/player/api.js',
                      'https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap'
                    ];

                    self.addEventListener('install', (event) => {
                      self.skipWaiting();
                      event.waitUntil(
                        caches.open(CACHE_NAME)
                          .then((cache) => {
                            return cache.addAll(urlsToCache);
                          })
                      );
                    });

                    self.addEventListener('fetch', (event) => {
                      // Strategy: Cache-First for App Shell, Network-Only for everything else (like media streams)
                      const url = event.request.url;
                      const shouldCache = urlsToCache.some(cacheUrl => url.includes(cacheUrl) || url.endsWith('/'));

                      if (shouldCache) {
                        event.respondWith(
                          caches.match(event.request)
                            .then((response) => {
                              return response || fetch(event.request);
                            })
                        );
                      } else {
                        // All other requests (external scripts, media, etc.) go directly to network
                        event.respondWith(fetch(event.request));
                      }
                    });

                    self.addEventListener('activate', (event) => {
                      const cacheWhitelist = [CACHE_NAME];
                      event.waitUntil(
                        caches.keys().then((cacheNames) => {
                          return Promise.all(
                            cacheNames.map((cacheName) => {
                              if (cacheWhitelist.indexOf(cacheName) === -1) {
                                return caches.delete(cacheName);
                              }
                            })
                          );
                        })
                      );
                    });
                `;

                const blob = new Blob([swContent], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        log('PWA Protocol: Service Worker registered successfully.');
                    })
                    .catch(error => {
                        log(`ERROR: Service Worker registration failed: ${error}`);
                    });
            });
        }


    </script>
</body>
</html>
